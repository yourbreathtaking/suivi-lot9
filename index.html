<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viaduc Manager Cloud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-in { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        textarea { resize: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 pb-10">

    <div id="app">
        <div class="flex h-screen items-center justify-center">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-slate-900"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            onSnapshot, 
            updateDoc, 
            deleteDoc,
            query 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // üî¥ REPLACE WITH YOUR FIREBASE CONFIG
            const firebaseConfig = {
        apiKey: "AIzaSyCwWW_-3rNSheLhfUNaFkinvDcBzEDukZI",
        authDomain: "lot-9-aabb8.firebaseapp.com",
        projectId: "lot-9-aabb8",
        storageBucket: "lot-9-aabb8.firebasestorage.app",
        messagingSenderId: "925973962540",
        appId: "1:925973962540:web:15df13581069d66af61689",
        measurementId: "G-BV9D48M6Z0"
};
        
        // INIT
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // STATE
        let state = {
            piers: [],
            currentView: 'dashboard',
            selectedViaduct: null,
            selectedPierId: null
        };

        const VIADUCS = [
            { id: 'ikkem', name: 'Viaduc Ikkem', color: 'bg-blue-600', text: 'text-blue-600', bg: 'bg-blue-50' },
            { id: 'maleh_nord', name: 'Viaduc Maleh Nord', color: 'bg-indigo-600', text: 'text-indigo-600', bg: 'bg-indigo-50' },
            { id: 'maleh_sud', name: 'Viaduc Maleh Sud', color: 'bg-violet-600', text: 'text-violet-600', bg: 'bg-violet-50' },
            { id: 'cherrat', name: 'Viaduc Cherrat', color: 'bg-emerald-600', text: 'text-emerald-600', bg: 'bg-emerald-50' },
            { id: 'dir', name: 'Viaduc DIR', color: 'bg-orange-600', text: 'text-orange-600', bg: 'bg-orange-50' },
        ];

        const DEFAULT_TASK_DEFS = [
            { key: 'implantation', label: 'Implantation G√©n√©rale', type: 'batch' },
            { key: 'tubes', label: "Tubes d'Auscultation", type: 'batch' },
            { key: 'fond_fouille', label: 'Fond de Fouille', type: 'individual' }
        ];

        // SYNC - Real-time listener
        function startSync() {
            try {
                const piersRef = collection(db, 'viaduc_piers');
                onSnapshot(piersRef, (snapshot) => {
                    state.piers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    render();
                }, (error) => {
                    console.error("Sync Error:", error);
                    showError("Erreur de synchronisation. V√©rifiez vos r√®gles Firestore.");
                });
            } catch (error) {
                console.error("Init Error:", error);
                showError("Configuration Firebase incorrecte. V√©rifiez votre config.");
            }
        }

        function showError(message) {
            document.getElementById('app').innerHTML = `
                <div class="flex h-screen items-center justify-center p-4">
                    <div class="bg-red-50 text-red-600 p-6 rounded-xl max-w-md">
                        <div class="font-bold mb-2 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                            </svg>
                            Erreur Firebase
                        </div>
                        <p class="text-sm mb-4">${message}</p>
                        <details class="text-xs bg-red-100 p-2 rounded">
                            <summary class="cursor-pointer font-bold">Checklist de d√©pannage</summary>
                            <ul class="mt-2 space-y-1 list-disc list-inside">
                                <li>Config Firebase correcte?</li>
                                <li>R√®gles Firestore: <code>allow read, write: if true;</code></li>
                                <li>Collection nomm√©e "viaduc_piers"</li>
                            </ul>
                        </details>
                    </div>
                </div>
            `;
        }

        // ACTIONS
        window.navigate = (view) => { state.currentView = view; render(); };
        window.goBack = () => { 
            if(state.currentView === 'pier') window.navigate('viaduct');
            else window.navigate('dashboard');
        };
        window.selectViaduct = (id) => {
            state.selectedViaduct = VIADUCS.find(v => v.id === id);
            state.currentView = 'viaduct';
            render();
        };
        window.selectPier = (id) => {
            state.selectedPierId = id;
            state.currentView = 'pier';
            render();
        };

        window.createNewPier = async () => {
            const name = document.getElementById('pierName').value.trim().toUpperCase();
            const count = parseInt(document.getElementById('pileCount').value) || 4;
            if(!name) return alert("Nom requis");

            const newId = `${state.selectedViaduct.id}_${Date.now()}`;
            
            const piles = Array.from({length: count}, (_, i) => {
                const obj = { id: i + 1 };
                DEFAULT_TASK_DEFS.forEach(d => obj[d.key] = false);
                return obj;
            });

            try {
                await setDoc(doc(db, 'viaduc_piers', newId), {
                    viaductId: state.selectedViaduct.id,
                    name,
                    observations: '',
                    taskDefinitions: DEFAULT_TASK_DEFS,
                    piles: piles,
                    createdAt: Date.now()
                });
                document.getElementById('pierName').value = '';
            } catch (error) {
                console.error("Create error:", error);
                alert("Erreur: " + error.message);
            }
        };

        window.updateObservations = async (id, val) => {
            try {
                await updateDoc(doc(db, 'viaduc_piers', id), { observations: val });
            } catch (error) {
                console.error("Update error:", error);
            }
        };

        window.toggleTask = async (pierId, pileIdx, taskKey) => {
            const pier = state.piers.find(p => p.id === pierId);
            const updatedPiles = [...pier.piles];
            updatedPiles[pileIdx][taskKey] = !updatedPiles[pileIdx][taskKey];
            try {
                await updateDoc(doc(db, 'viaduc_piers', pierId), { piles: updatedPiles });
            } catch (error) {
                console.error("Toggle error:", error);
            }
        };

        window.toggleBatch = async (pierId, taskKey, val) => {
            const pier = state.piers.find(p => p.id === pierId);
            const updatedPiles = pier.piles.map(p => ({...p, [taskKey]: val}));
            try {
                await updateDoc(doc(db, 'viaduc_piers', pierId), { piles: updatedPiles });
            } catch (error) {
                console.error("Batch toggle error:", error);
            }
        };

        window.deletePier = async (id) => {
            if(confirm("Supprimer cette pile d√©finitivement ?")) {
                try {
                    await deleteDoc(doc(db, 'viaduc_piers', id));
                    window.goBack();
                } catch (error) {
                    console.error("Delete error:", error);
                }
            }
        };

        // RENDERING
        function render() {
            const root = document.getElementById('app');
            let content = '';

            switch(state.currentView) {
                case 'dashboard': content = renderDashboard(); break;
                case 'viaduct': content = renderViaductView(); break;
                case 'pier': content = renderPierDetail(); break;
            }

            root.innerHTML = `
                <header class="bg-white border-b border-slate-200 sticky top-0 z-30 shadow-sm">
                    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
                        <div class="flex items-center space-x-3 cursor-pointer" onclick="navigate('dashboard')">
                            <div class="bg-slate-900 text-white p-2 rounded-lg shadow-lg shadow-slate-200"><i data-lucide="hard-hat"></i></div>
                            <h1 class="font-bold text-lg tracking-tight">Viaduc Manager</h1>
                        </div>
                        ${state.currentView !== 'dashboard' ? `
                            <button onclick="goBack()" class="flex items-center text-sm font-bold text-slate-500 hover:text-slate-900 transition-colors">
                                <i data-lucide="arrow-left" class="mr-1 w-4 h-4"></i> Retour
                            </button>
                        ` : '<div class="text-[10px] bg-green-50 text-green-600 px-2 py-1 rounded-full font-bold">‚úì CONNECT√â</div>'}
                    </div>
                </header>
                <main class="max-w-4xl mx-auto px-4 py-6">${content}</main>
            `;
            lucide.createIcons();
        }

        function renderDashboard() {
            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 animate-in">
                    ${VIADUCS.map(v => {
                        const stats = getViaductStats(v.id);
                        return `
                            <div onclick="selectViaduct('${v.id}')" class="bg-white rounded-2xl p-5 border border-slate-200 hover:shadow-xl hover:-translate-y-1 transition-all cursor-pointer group">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 rounded-xl ${v.bg} ${v.text} transition-transform group-hover:scale-110"><i data-lucide="map-pin"></i></div>
                                    <span class="text-[10px] font-bold px-2 py-1 rounded-full ${stats.remaining > 0 ? 'bg-amber-50 text-amber-600' : 'bg-green-50 text-green-600'}">
                                        ${stats.remaining > 0 ? `${stats.remaining} t√¢ches` : 'Termin√©'}
                                    </span>
                                </div>
                                <h2 class="font-bold text-lg">${v.name}</h2>
                                <p class="text-xs text-slate-400 mb-4">${stats.count} piles enregistr√©es</p>
                                <div class="w-full bg-slate-100 rounded-full h-1.5 overflow-hidden">
                                    <div class="h-full ${v.color} transition-all duration-700" style="width: ${stats.progress}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderViaductView() {
            const viPiers = state.piers.filter(p => p.viaductId === state.selectedViaduct.id);
            return `
                <div class="space-y-6 animate-in">
                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 class="font-bold text-lg mb-4">Ajouter une Pile</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                            <input id="pierName" type="text" placeholder="Nom (ex: P1)" class="p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold focus:ring-2 focus:ring-slate-900 outline-none">
                            <input id="pileCount" type="number" value="4" min="1" max="20" class="p-3 bg-slate-50 border border-slate-200 rounded-xl font-bold">
                        </div>
                        <button onclick="createNewPier()" class="w-full bg-slate-900 text-white font-bold rounded-xl py-3 shadow-lg shadow-slate-200 active:scale-95 transition-all">
                            Cr√©er sur le Cloud
                        </button>
                    </div>

                    <div class="grid grid-cols-1 gap-2">
                        ${viPiers.length === 0 ? `
                            <div class="bg-slate-50 rounded-xl p-8 text-center text-slate-400">
                                <i data-lucide="inbox" class="mx-auto mb-2 w-8 h-8"></i>
                                <p class="text-sm font-bold">Aucune pile enregistr√©e</p>
                            </div>
                        ` : viPiers.map(p => {
                            const s = getPierStats(p);
                            return `
                                <div onclick="selectPier('${p.id}')" class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between cursor-pointer hover:border-slate-300 transition-all">
                                    <div class="flex items-center space-x-3">
                                        <div class="h-10 w-10 bg-slate-900 text-white rounded-lg flex items-center justify-center font-bold">${p.name}</div>
                                        <div class="font-bold">Pile ${p.name}</div>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        ${p.observations ? '<i data-lucide="message-square" class="w-3 h-3 text-indigo-500"></i>' : ''}
                                        <span class="text-[10px] font-bold ${s.remaining > 0 ? 'text-amber-500' : 'text-green-500'} uppercase">${s.remaining > 0 ? `${s.remaining} √† faire` : 'OK'}</span>
                                        <i data-lucide="chevron-right" class="text-slate-300 w-4 h-4"></i>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderPierDetail() {
            const pier = state.piers.find(p => p.id === state.selectedPierId);
            if (!pier) return "";

            return `
                <div class="space-y-6 animate-in">
                    <div class="flex justify-between items-center bg-white p-4 rounded-2xl border border-slate-200">
                        <div>
                            <h2 class="font-bold text-lg leading-none">Pile ${pier.name}</h2>
                            <span class="text-[10px] text-slate-400 font-bold uppercase">${state.selectedViaduct.name}</span>
                        </div>
                        <button onclick="deletePier('${pier.id}')" class="text-slate-300 hover:text-red-500 transition-colors p-2"><i data-lucide="trash-2"></i></button>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="bg-slate-50 px-4 py-2 border-b border-slate-200"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Observations</span></div>
                        <div class="p-4">
                            <textarea onchange="updateObservations('${pier.id}', this.value)" class="w-full bg-slate-50 p-3 rounded-xl text-sm border border-slate-100 outline-none focus:border-indigo-300 min-h-[80px]">${pier.observations || ''}</textarea>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                        <div class="bg-slate-50 px-4 py-2 border-b border-slate-200"><span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">T√¢ches Globales</span></div>
                        <div class="p-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                            ${pier.taskDefinitions.filter(t => t.type === 'batch').map(t => {
                                const isDone = pier.piles.every(p => p[t.key]);
                                return `
                                    <button onclick="toggleBatch('${pier.id}', '${t.key}', ${!isDone})" class="flex items-center p-3 rounded-xl border-2 transition-all text-left ${isDone ? 'bg-green-50 border-green-500' : 'bg-white border-slate-100 hover:border-slate-300'}">
                                        <div class="flex-1 font-bold text-xs">${t.label}</div>
                                        <i data-lucide="check-circle-2" class="w-5 h-5 ${isDone ? 'text-green-500' : 'text-slate-200'}"></i>
                                    </button>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${pier.piles.map((pile, pIdx) => `
                            <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
                                <div class="bg-slate-50 px-4 py-2 font-bold text-[10px] text-slate-500 border-b border-slate-100">PIEU ${pile.id}</div>
                                <div class="p-3 space-y-1.5">
                                    ${pier.taskDefinitions.filter(t => t.type === 'individual').map(task => `
                                        <button onclick="toggleTask('${pier.id}', ${pIdx}, '${task.key}')" class="w-full flex justify-between items-center p-2.5 rounded-lg border transition-all ${pile[task.key] ? 'bg-green-50 border-green-200' : 'bg-slate-50 border-transparent hover:border-slate-200'}">
                                            <span class="text-[11px] font-bold ${pile[task.key] ? 'text-green-700' : 'text-slate-600'}">${task.label}</span>
                                            <div class="h-4 w-4 rounded border flex items-center justify-center ${pile[task.key] ? 'bg-green-500 border-green-500 text-white' : 'bg-white border-slate-300'}">
                                                ${pile[task.key] ? '<i data-lucide="check" class="w-3 h-3"></i>' : ''}
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function getPierStats(pier) {
            const ind = pier.taskDefinitions.filter(t => t.type === 'individual');
            const total = pier.piles.length * ind.length;
            let done = 0;
            pier.piles.forEach(p => ind.forEach(t => { if(p[t.key]) done++; }));
            return { remaining: total - done, total };
        }

        function getViaductStats(viaductId) {
            const viPiers = state.piers.filter(p => p.viaductId === viaductId);
            let total = 0, rem = 0;
            viPiers.forEach(p => { const s = getPierStats(p); total += s.total; rem += s.remaining; });
            const progress = total === 0 ? 0 : Math.round(((total - rem) / total) * 100);
            return { progress, remaining: rem, count: viPiers.length };
        }

        // START
        startSync();
    </script>

</body>
</html>
